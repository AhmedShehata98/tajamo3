var U=Object.defineProperty;var S=(a,t,e)=>t in a?U(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var g=(a,t,e)=>S(a,typeof t!="symbol"?t+"":t,e);import F from"./GQPUnmNe.js";import{M as E,N as k,d as j,r as $,a as O,h as n,u as d,t as m,j as b,l as B,x as _,b as p}from"./CMCxBn70.js";import{u as D}from"./M9v_ylco.js";import{u as N}from"./DqayCACx.js";import{u as I}from"./D2lfmPiW.js";import"./Cb26PGfG.js";import"./C7JPyPC4.js";const q=E("/images/fawry.png"),R=E("/images/credit-card.png"),J="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let A=(a=21)=>{let t="",e=crypto.getRandomValues(new Uint8Array(a|=0));for(;a--;)t+=J[e[a]&63];return t};const G=async a=>{try{return await(await fetch(`/api/payments/${a.id}`,{method:"PATCH",body:JSON.stringify(a.body),headers:{"Content-Type":"application/json"}})).json()}catch(t){throw t}},L=async a=>{try{return(await fetch("/api/payments",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json"}})).json()}catch(t){throw t}},V=async a=>{try{return(await fetch(`/api/payments/${a}`,{method:"DELETE",headers:{"Content-Type":"application/json"}})).json()}catch(t){throw t}},x=a=>Math.round(a*100);class z{async pay(t){var e;try{const o={amount:t.amount,method:"paymob_credit_card",status:"pending",paid_at:new Date().toISOString(),order_id:t.orders[0].id,transaction_reference:null},s=await L(o),c={amount:x(t.amount),currency:t.currency,payment_methods:["card"],items:t.orders.map(i=>({id:i.id,name:i.name,amount:x(i.amount),description:i.description||"",quantity:i.quantity||1})),billing_data:t.billingData,notification_url:`${k().public.websiteUrl}/api/payments/confirmation`,redirection_url:`${k().public.websiteUrl}/dashboard/payments/redirect`,extras:{api:{orderId:(e=t.orders.at(0))==null?void 0:e.id,paymentId:s.data.id}}},r=await $fetch("/api/payment-getaways/paymob",{method:"POST",body:JSON.stringify(c),headers:{"Content-Type":"application/json"},async onResponse({response:i}){if(i.ok){const l=i._data;await G({id:s.data.id,body:{transaction_reference:l.orderId.toString()}})}else await V(s.data.id)}});return{amount:r.amount,currency:r.currency,date:r.date,status:r.status,extraData:{checkoutUrl:r.checkoutUrl}}}catch{throw new Error("Failed to pay with credit card")}}}class H{async pay(t){try{return await $fetch("/api/payments",{method:"POST",body:JSON.stringify({payment:t,method:"fawry"})})}catch{throw new Error("Failed to pay with fawry")}}}class v{constructor(t){this.strategy=t}pay(t){return this.strategy.pay(t)}}class M{createPayment(t){switch(t){case"paymob_credit_card":return new v(new z);case"fawry":return new v(new H);default:throw new Error("Invalid payment method")}}}async function T(a){try{return await $fetch("/api/orders",{method:"POST",body:JSON.stringify(a)})}catch{throw new Error("Failed to create order")}}async function P(a){try{const t=await fetch(`/api/ticket-types/${a}`);if(!t.ok)throw new Error("Failed to get ticket type");const e=await t.json();return console.log("data: ",e),e}catch(t){throw new Error(t instanceof Error?t.message:"Failed to get ticket type")}}class K{constructor(t,e){g(this,"payment");this.event=t,this.user=e,this.event=t,this.user=e,this.payment=new M}generateTicketCode(){return`TICKET-${A(10)}`}async bookFreeTicket(t){try{const e=await P(t);if(!e)throw new Error("Ticket type not found");const o=await T({event_id:this.event.id,ticket_type_id:t,user_id:this.user.id,final_amount:e.data.price,status:"pending"}),s=await this.payment.createPayment("paymob_credit_card").pay({amount:e.data.price,currency:"EGP",orders:[{id:o.id,name:`Booking event ${this.event.name}`,amount:e.data.price,description:`Booking event ${this.event.name},with ticket ${e.data.name}`,quantity:1}],billingData:{first_name:this.user.first_name,last_name:this.user.last_name,phone_number:this.user.phone,email:this.user.email,building:"Unknown",city:"Unknown",floor:"Unknown",state:"Unknown",street:"Unknown",apartment:"Unknown",country:"Unknown"}});return{order:o,payment:s}}catch{throw new Error("Failed to book free ticket")}}async bookPaidTicket(t,e){let o=null;try{const s=await P(t);if(!s||!s.data)throw new Error("Ticket type not found");o=await T({event_id:this.event.id,ticket_type_id:s.data.id,user_id:this.user.id,final_amount:s.data.price,status:"pending"});const c=await this.payment.createPayment(e).pay({amount:s.data.price,currency:"EGP",orders:[{id:o.id,name:`${this.event.name}`,amount:s.data.price,description:`Booking event ${this.event.name},with ticket ${s.data.name}`,quantity:1}],billingData:{apartment:"Unknown",first_name:this.user.first_name,last_name:this.user.last_name,phone_number:this.user.phone,email:this.user.email,street:"Unknown",building:"Unknown",city:"Unknown",country:"Unknown",floor:"Unknown",state:"Unknown"}});return{order:o,payment:c}}catch{throw o&&await removeOrderById(o.id),new Error("Failed to book paid ticket")}}}const W={class:"flex flex-col gap-4 p-4"},Q={class:"w-fit max-md:w-full flex items-start justify-start gap-4 p-2 glass-card"},X=["src"],Y={class:"flex flex-col items-start justify-start gap-2 divide-y-2"},Z={class:"py-4"},tt={class:"text-lg font-semibold text-text-primary"},et={class:"text-secondary-text max-w-md"},at={class:"flex items-center gap-1 capitalize"},nt={class:"text-accent font-semibold"},rt={class:"flex flex-col items-center justify-start gap-4 bg-class max-md:p-0 p-4 mt-5 h-[calc(100vh-10rem)]"},ot={class:"w-4/5 max-md:w-full flex flex-col gap-2 grid grid-cols-1 md:grid-cols-2 gap-4"},st={class:"max-md:w-full flex flex-col items-center gap-2 glass-card p-6 hover:scale-105 hover:translate-y-[-14px] transition-all duration-300"},it={class:"flex flex-col items-center gap-2 glass-card p-6 hover:scale-105 hover:translate-y-[-10px] transition-all duration-300"},ct=["disabled"],ft=j({__name:"index",setup(a){const t=$(!1),{userStore:e}=D(),{eventDetailsState:o}=N(),s=async()=>{try{if(console.log("bookPaidTicket"),!o.value.event)throw new Error("Event not found");if(!e.value)throw new Error("User not found");if(!o.value.selectedTicketType)throw new Error("Ticket type not found");t.value=!0;const i=(await new K(o.value.event,e.value).bookPaidTicket(o.value.selectedTicketType.id,"paymob_credit_card")).payment.extraData.checkoutUrl;window.open(i)}catch(c){console.error("Error booking paid ticket: ",c)}finally{t.value=!1}};return I({title:"Payments",meta:[{name:"description",content:"Payments page for the dashboard of the user to manage payments"}]}),(c,r)=>{var l,y,u,h,w,f;const i=F;return p(),O("div",W,[r[7]||(r[7]=n("h1",{class:"text-2xl font-bold text-text-primary"},"Payments",-1)),n("div",Q,[n("figure",null,[n("img",{src:(l=d(o).event)==null?void 0:l.image,alt:"order-image",class:"w-44 h-44 rounded-lg object-cover"},null,8,X)]),n("div",Y,[n("span",Z,[n("h4",tt,m((y=d(o).event)==null?void 0:y.name),1),n("p",et,m((u=d(o).event)==null?void 0:u.description),1)]),n("span",null,[n("h5",at,[b(i,{name:"famicons:ticket-sharp",class:"text-2xl"}),B(" "+m((h=d(o).selectedTicketType)==null?void 0:h.name),1)]),n("p",nt,m((f=(w=d(o).selectedTicketType)==null?void 0:w.price)==null?void 0:f.toLocaleString("en-EG",{style:"currency",currency:"EGP"})),1)])])]),n("div",rt,[n("ul",ot,[n("li",st,[r[1]||(r[1]=n("h4",{class:"text-3xl text-center font-bold text-text-primary"}," Fawry ",-1)),r[2]||(r[2]=n("p",{class:"text-sm secondary-text"}," Fawry is a payment gateway that allows you to accept payments from your customers. ",-1)),r[3]||(r[3]=n("figure",{class:"size-48 flex items-center justify-center p-2 mt-4"},[n("img",{src:q,alt:"Fawry",width:"128",height:"128",class:"rounded-lg w-full"})],-1)),n("button",{type:"button",onClick:r[0]||(r[0]=(...C)=>c.bookPaidTicket&&c.bookPaidTicket(...C)),class:"btn bg-accent w-fit self-center size-14 aspect-square rounded-full mt-auto mb-4 hover:bg-accent/80"},[b(i,{name:"mdi:arrow-right",class:"w-6 h-6"})])]),n("li",it,[r[4]||(r[4]=n("h4",{class:"text-3xl text-center font-bold text-text-primary"}," Credit Card ",-1)),r[5]||(r[5]=n("p",{class:"text-sm secondary-text"}," Credit Card is a payment gateway that allows you to accept payments from your customers. ",-1)),r[6]||(r[6]=n("figure",{class:"size-48 flex items-center justify-center p-2 mt-4"},[n("img",{src:R,width:"128",height:"128",alt:"Credit Card",class:"rounded-lg w-full"})],-1)),n("button",{type:"button",onClick:s,disabled:d(t),class:"btn bg-accent w-fit self-center size-14 aspect-square rounded-full mt-auto mb-4 hover:bg-accent/80"},[d(t)?(p(),_(i,{key:1,name:"mdi:loading",class:"w-12 h-12 animate-spin"})):(p(),_(i,{key:0,name:"mdi:arrow-right",class:"w-6 h-6"}))],8,ct)])])])])}}});export{ft as default};
